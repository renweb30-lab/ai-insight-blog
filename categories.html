<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIインサイトラボ | カテゴリ一覧</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css"
    />
    <link rel="stylesheet" href="/style.css" />
  </head>

  <body>
    <header>
      <div class="header-inner">
        <a class="logo" href="index.html">Ren AI Lab</a>
        <nav aria-label="メインナビゲーション">
          <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="categories.html">Categories</a></li>
            <li><a href="archive.html">Archive</a></li>
            <li><a href="profile.html">Profile</a></li>
          </ul>
        </nav>
        <button class="menu-toggle" aria-label="メニューを開閉" aria-expanded="false">
          <i class="fa-solid fa-bars"></i>
        </button>
      </div>
      <div class="mobile-nav" aria-label="モバイルナビゲーション">
        <a href="index.html">Home</a>
        <a href="categories.html">Categories</a>
        <a href="archive.html">Archive</a>
        <a href="profile.html">Profile</a>
      </div>
    </header>

    <main>
      <div class="container">
        <section class="hero" style="margin-bottom: 32px;">
          <h1>カテゴリから記事を探す</h1>
          <p>
            気になるテーマ別に記事をピックアップ。カテゴリを切り替えて、知りたい情報だけに集中しましょう。
          </p>
          <div class="hero-actions">
            <div class="button secondary" style="cursor: default;">
              <i class="fa-solid fa-tags"></i>
              <span data-category-count>0カテゴリ</span>
            </div>
          </div>
        </section>

        <div class="layout-split">
          <aside class="sticky-section" aria-label="カテゴリフィルター">
            <h2 class="visually-hidden">カテゴリフィルター</h2>
            <div class="badge-grid" data-category-list></div>
          </aside>

          <section aria-live="polite" aria-labelledby="category-title">
            <header class="section-header">
              <div>
                <p class="category-badge" data-selected-category></p>
                <h2 id="category-title" style="margin-top: 8px;">カテゴリー名</h2>
              </div>
              <div class="status-text" data-category-status></div>
            </header>

            <div class="card-grid" data-category-articles>
              <div class="status-text">
                <div class="loader" role="status" aria-label="読み込み中"></div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </main>

    <footer>
      <div class="footer-inner">
        <div class="footer-links">
          <a href="https://www.instagram.com/ren_web3.0_/" target="_blank" rel="noopener">Instagram</a>
          <a href="https://coconala.com/users/5831852" target="_blank" rel="noopener">ココナラ</a>
          <a href="https://www.threads.com/@ren_web3.0_/" target="_blank" rel="noopener">Threads</a>
        </div>
        <p class="footer-copy">&copy; <span data-current-year></span> AI Insight Lab</p>
      </div>
    </footer>

    <script>
      // 年
      document.querySelectorAll("[data-current-year]").forEach((el) => {
        el.textContent = String(new Date().getFullYear());
      });

      // モバイルメニュー
      (function setupMenu() {
        const btn = document.querySelector(".menu-toggle");
        const mobile = document.querySelector(".mobile-nav");
        if (!btn || !mobile) return;

        btn.addEventListener("click", () => {
          const opened = btn.getAttribute("aria-expanded") === "true";
          btn.setAttribute("aria-expanded", String(!opened));
          mobile.style.display = opened ? "none" : "block";
        });
      })();

      const CATEGORY_LABEL = {
        "ai-stocks": "AI株情報",
        "ai-intro": "AI使い方入門",
        "ai-tools": "AIツール紹介",
        "ai-news": "AI関連ニュース",
      };

      function escapeHtml(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function fmtDate(iso) {
        try {
          return new Date(iso).toLocaleDateString("ja-JP");
        } catch {
          return iso || "";
        }
      }

      function cardHtml(p) {
        const cat = p.categoryId;
        const catLabel = CATEGORY_LABEL[cat] || cat || "";
        const href = `post.html?id=${encodeURIComponent(p.id)}`;

        return `
          <article class="card">
            <div class="meta">
              ${catLabel ? `<span class="badge"><i class="fa-solid fa-hashtag"></i> ${escapeHtml(catLabel)}</span>` : ""}
              <span><i class="fa-regular fa-calendar"></i> ${escapeHtml(fmtDate(p.publishedAt))}</span>
            </div>

            <a class="title-link" href="${href}">
              ${escapeHtml(p.title || "")}
            </a>

            ${p.eyecatchUrl ? `<img class="thumb" src="${escapeHtml(p.eyecatchUrl)}" alt="" loading="lazy" />` : ""}

            ${p.summary ? `<p class="muted">${escapeHtml(p.summary)}</p>` : ""}
          </article>
        `;
      }

      async function fetchPosts() {
        const r = await fetch("/api/posts", { cache: "no-store" });
        if (!r.ok) throw new Error("Failed to fetch /api/posts");
        const data = await r.json();
        return data.posts || [];
      }

      function getCategoryFromUrl() {
        const params = new URLSearchParams(location.search);
        return params.get("category") || "";
      }

      function uniqueCategories(posts) {
        const ids = posts
          .map((p) => (Array.isArray(p.categoryId) ? p.categoryId[0] : p.categoryId))
          .filter(Boolean);
        return Array.from(new Set(ids));
      }

      function renderCategoryBadges(cats, selected) {
        const el = document.querySelector("[data-category-list]");
        if (!el) return;

        // 先に「すべて」を出す
        const allBadge = `<a class="badge" href="categories.html" ${selected ? "" : 'aria-current="page"'}>すべて</a>`;

        const rest = cats
          .map((id) => {
            const label = CATEGORY_LABEL[id] || id;
            const active = id === selected ? 'aria-current="page"' : "";
            return `<a class="badge" href="categories.html?category=${encodeURIComponent(id)}" ${active}>${escapeHtml(label)}</a>`;
          })
          .join("");

        el.innerHTML = allBadge + rest;
      }

      function renderHeader(selected, count) {
        const badgeEl = document.querySelector("[data-selected-category]");
        const titleEl = document.getElementById("category-title");
        const countEl = document.querySelector("[data-category-count]");

        if (countEl) countEl.textContent = `${count}カテゴリ`;

        if (!selected) {
          if (badgeEl) badgeEl.textContent = "すべて";
          if (titleEl) titleEl.textContent = "すべての記事";
          return;
        }

        const label = CATEGORY_LABEL[selected] || selected;
        if (badgeEl) badgeEl.textContent = label;
        if (titleEl) titleEl.textContent = `${label} の記事`;
      }

      (async function boot() {
        const statusEl = document.querySelector("[data-category-status]");
        const listEl = document.querySelector("[data-category-articles]");

        try {
          const posts = await fetchPosts();
          const cats = uniqueCategories(posts).sort();
          const selected = getCategoryFromUrl();

          renderCategoryBadges(cats, selected);
          renderHeader(selected, cats.length);

          const filtered = selected
            ? posts.filter((p) => {
                const id = Array.isArray(p.categoryId) ? p.categoryId[0] : p.categoryId;
                return id === selected;
              })
            : posts;

          listEl.innerHTML = filtered.length
            ? filtered.map(cardHtml).join("")
            : `<p class="status-text">このカテゴリの記事はまだありません</p>`;

          if (statusEl) statusEl.textContent = "";
        } catch (e) {
          if (listEl) listEl.innerHTML = `<p class="status-text">読み込みに失敗しました</p>`;
          if (statusEl) statusEl.textContent = String(e);
        }
      })();
    </script>
  </body>
</html>
