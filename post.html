<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>記事</title>
</head>
<body>
  <a href="/" style="display:inline-block; margin:16px 0;">← 戻る</a>
  <div id="post"></div>

  <script>
    async function loadPost(id) {
      const r = await fetch("/api/posts", { cache: "no-store" });
      const data = await r.json();
      const posts = data.posts || [];
      return posts.find(p => p.id === id) || null;
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function fmtDate(iso) {
      try {
        return new Date(iso).toLocaleDateString("ja-JP");
      } catch {
        return iso || "";
      }
    }

    (async () => {
      const params = new URLSearchParams(location.search);
      const id = params.get("id");
      const el = document.getElementById("post");

      if (!id) {
        el.innerHTML = "記事IDがありません";
        return;
      }

      el.innerHTML = "読み込み中...";
      const p = await loadPost(id);

      if (!p) {
        el.innerHTML = "記事が見つかりません";
        return;
      }

      document.title = p.title || "記事";

      el.innerHTML = `
        <h1>${escapeHtml(p.title)}</h1>
        <div style="opacity:0.8; margin:8px 0;">${escapeHtml(fmtDate(p.publishedAt))}</div>
        ${p.eyecatchUrl ? `<img src="${escapeHtml(p.eyecatchUrl)}" alt="" style="width:100%; max-width:900px; border-radius:12px; margin:12px 0;" />` : ""}
        ${p.content ? `<div style="white-space:pre-wrap; line-height:1.8;">${escapeHtml(p.content)}</div>` : "<p>本文がまだ設定されていません（microCMSの本文フィールドIDを合わせる必要あり）</p>"}
      `;
    })();
  </script>
</body>
</html>
