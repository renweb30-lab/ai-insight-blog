<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIインサイトラボ | ホーム</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css"
    />
    <link rel="stylesheet" href="/style.css" />
  </head>

  <body>
    <header>
      <div class="header-inner">
        <a class="logo" href="index.html">Ren AI Lab</a>
        <nav aria-label="メインナビゲーション">
          <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="categories.html">Categories</a></li>
            <li><a href="archive.html">Archive</a></li>
            <li><a href="profile.html">Profile</a></li>
          </ul>
        </nav>
        <button class="menu-toggle" aria-label="メニューを開閉" aria-expanded="false">
          <i class="fa-solid fa-bars"></i>
        </button>
      </div>

      <div class="mobile-nav" aria-label="モバイルナビゲーション">
        <a href="index.html">Home</a>
        <a href="categories.html">Categories</a>
        <a href="archive.html">Archive</a>
        <a href="profile.html">Profile</a>
      </div>
    </header>

    <main>
      <div class="container">
        <section class="hero">
          <h1>AIとテックの“いま”を、ストレスなくキャッチアップ</h1>
          <p>
            投資・ビジネス・実務活用まで、AI初心者〜中級者のためのナレッジハブ。
            最新ニュースからツール紹介まで、読むべき情報だけを厳選してお届けします。
          </p>
          <div class="hero-actions">
            <a href="#latest" class="button primary">
              <i class="fa-solid fa-tower-broadcast"></i> 最新記事を見る
            </a>
            <a href="categories.html" class="button secondary">
              <i class="fa-solid fa-layer-group"></i> カテゴリから探す
            </a>
          </div>
        </section>

        <section class="insight-panel" aria-labelledby="insight-panel-title">
          <div class="section-header">
            <h2 id="insight-panel-title">Insight Signal</h2>
            <span class="section-subtitle">今日の注目トピックをワンタップで切り替え</span>
          </div>
          <div class="insight-tabs" role="tablist" aria-label="注目テーマ">
            <button class="insight-tab is-active" type="button" data-insight="news" role="tab" aria-selected="true">
              <i class="fa-solid fa-newspaper"></i> ニュース
            </button>
            <button class="insight-tab" type="button" data-insight="tools" role="tab" aria-selected="false">
              <i class="fa-solid fa-wand-magic-sparkles"></i> ツール
            </button>
            <button class="insight-tab" type="button" data-insight="stocks" role="tab" aria-selected="false">
              <i class="fa-solid fa-chart-line"></i> 株・ビジネス
            </button>
          </div>
          <div class="insight-card" data-insight-card>
            <div class="insight-main">
              <p class="insight-label">Latest Signal</p>
              <h3 data-insight-title>読み込み中...</h3>
              <p class="insight-text" data-insight-text></p>
              <div class="insight-tags" data-insight-tags></div>
            </div>
            <div class="insight-aside">
              <div class="insight-meta" data-insight-meta></div>
              <a class="button secondary" data-insight-link href="archive.html">
                <i class="fa-solid fa-arrow-right"></i> 記事を読む
              </a>
            </div>
          </div>
          <div class="insight-footer">
            <a class="button secondary" href="archive.html">
              <i class="fa-solid fa-arrow-right"></i> 注目トピックを深掘り
            </a>
          </div>
        </section>

        <section id="recommended" aria-labelledby="recommended-title">
          <div class="section-header">
            <h2 id="recommended-title">おすすめ記事</h2>
            <a href="archive.html">すべての記事を見る</a>
          </div>
          <div class="card-grid" data-recommended-list>
            <div class="status-text">
              <div class="loader" role="status" aria-label="読み込み中"></div>
            </div>
          </div>
        </section>

        <section aria-labelledby="category-quick-nav">
          <div class="section-header">
            <h2 id="category-quick-nav">カテゴリから探す</h2>
          </div>
          <div class="badge-grid" data-category-shortcuts></div>
        </section>

        <section id="latest" aria-labelledby="latest-title">
          <div class="section-header">
            <h2 id="latest-title">最新記事</h2>
            <a href="archive.html">アーカイブ</a>
          </div>
          <div class="card-grid" data-latest-list>
            <div class="status-text">
              <div class="loader" role="status" aria-label="読み込み中"></div>
            </div>
          </div>
          <div class="status-text" data-latest-status></div>
          <div style="text-align: center; margin-top: 16px;">
            <button class="button secondary" data-load-more>
              <i class="fa-solid fa-plus"></i> もっと見る
            </button>
          </div>
        </section>
      </div>
    </main>

    <footer>
      <div class="footer-inner">
        <div class="footer-top">
          <div class="footer-brand">
            <a class="footer-logo" href="index.html">Ren AI Lab</a>
            <p class="footer-description">
              AIニュース、ツール、投資インサイトを一つにまとめたビジネス向けナレッジメディア。
              使える視点だけを厳選してお届けします。
            </p>
          </div>
          <div class="footer-grid">
            <div class="footer-column">
              <p class="footer-title">Explore</p>
              <a href="index.html">Home</a>
              <a href="categories.html">Categories</a>
              <a href="archive.html">Archive</a>
              <a href="profile.html">Profile</a>
            </div>
            <div class="footer-column">
              <p class="footer-title">Categories</p>
              <a href="categories.html?category=ai-news">AI関連ニュース</a>
              <a href="categories.html?category=ai-tools">AIツール</a>
              <a href="categories.html?category=ai-stocks">AI株情報</a>
              <a href="categories.html?category=ai-intro">AI入門</a>
            </div>
            <div class="footer-column">
              <p class="footer-title">Connect</p>
              <a href="https://www.instagram.com/ren_web3.0_/" target="_blank" rel="noopener">Instagram</a>
              <a href="https://coconala.com/users/5831852" target="_blank" rel="noopener">ココナラ</a>
              <a href="https://www.threads.com/@ren_web3.0_/" target="_blank" rel="noopener">Threads</a>
            </div>
          </div>
        </div>
        <div class="footer-bottom">
          <p class="footer-copy">&copy; <span data-current-year></span> Ren AI Lab. All rights reserved.</p>
          <p class="footer-note">Empowering teams with practical AI insights.</p>
        </div>
      </div>
    </footer>

    <script src="/category-map.js"></script>
    <!-- ✅ ここからが「記事復活」に必要 -->
    <script>
      // 年
      document.querySelectorAll("[data-current-year]").forEach((el) => {
        el.textContent = String(new Date().getFullYear());
      });

      // モバイルメニュー
      (function setupMenu() {
        const btn = document.querySelector(".menu-toggle");
        const mobile = document.querySelector(".mobile-nav");
        if (!btn || !mobile) return;

        btn.addEventListener("click", () => {
          const opened = btn.getAttribute("aria-expanded") === "true";
          btn.setAttribute("aria-expanded", String(!opened));
          mobile.style.display = opened ? "none" : "block";
        });
      })();

      // microCMS proxy (/api/posts) から取得して描画
      const INSIGHT_CONFIG = {
        news: {
          categoryId: "ai-news",
          label: "AI関連ニュース",
        },
        tools: {
          categoryId: "ai-tools",
          label: "AIツール",
        },
        stocks: {
          categoryId: "ai-stocks",
          label: "AI株情報",
        },
      };

      let insightPosts = {};

      function escapeHtml(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function fmtDate(iso) {
        try {
          return new Date(iso).toLocaleDateString("ja-JP");
        } catch {
          return iso || "";
        }
      }

      function extractTags(post) {
        const raw = post?.tags ?? post?.tag ?? post?.labels;
        if (Array.isArray(raw)) return raw.filter(Boolean);
        if (typeof raw === "string") {
          return raw
            .split(",")
            .map((tag) => tag.trim())
            .filter(Boolean);
        }
        return [];
      }

      function buildInsightPosts(posts) {
        const sorted = [...posts].sort(
          (a, b) => new Date(b.publishedAt) - new Date(a.publishedAt)
        );
        const result = {};
        Object.entries(INSIGHT_CONFIG).forEach(([key, config]) => {
          result[key] =
            sorted.find((post) => window.normalizeCategoryId(post.categoryId) === config.categoryId) || null;
        });
        return result;
      }

      function renderInsightCard(key) {
        const config = INSIGHT_CONFIG[key];
        const post = insightPosts[key] || null;
        if (!config) return;

        const titleEl = document.querySelector("[data-insight-title]");
        const textEl = document.querySelector("[data-insight-text]");
        const tagEl = document.querySelector("[data-insight-tags]");
        const metaEl = document.querySelector("[data-insight-meta]");
        const linkEl = document.querySelector("[data-insight-link]");

        if (!post) {
          if (titleEl) titleEl.textContent = "記事がまだありません";
          if (textEl) textEl.textContent = "このカテゴリの最新記事が公開され次第、ここに表示されます。";
          if (tagEl) tagEl.innerHTML = `<span class="insight-tag is-muted">タグがまだありません</span>`;
          if (metaEl) {
            metaEl.innerHTML = `
              <div><span>カテゴリ</span><strong>${escapeHtml(config.label)}</strong></div>
              <div><span>ステータス</span><strong>準備中</strong></div>
            `;
          }
          if (linkEl) {
            linkEl.href = `categories.html?category=${encodeURIComponent(config.categoryId)}`;
            linkEl.classList.add("is-disabled");
            linkEl.setAttribute("aria-disabled", "true");
          }
          return;
        }

        const tags = extractTags(post);
        const date = fmtDate(post.publishedAt);
        const href = `post.html?id=${encodeURIComponent(post.id)}`;

        if (titleEl) titleEl.textContent = post.title || "";
        if (textEl) textEl.textContent = post.summary || "要約は準備中です。";
        if (tagEl) {
          const fallbackTags = tags.length ? tags : [config.label];
          tagEl.innerHTML = fallbackTags
            .map((tag) => `<span class="insight-tag">${escapeHtml(tag)}</span>`)
            .join("");
        }
        if (metaEl) {
          metaEl.innerHTML = `
            <div><span>カテゴリ</span><strong>${escapeHtml(config.label)}</strong></div>
            <div><span>更新日</span><strong>${escapeHtml(date)}</strong></div>
          `;
        }
        if (linkEl) {
          linkEl.href = href;
          linkEl.classList.remove("is-disabled");
          linkEl.removeAttribute("aria-disabled");
        }
      }

      (function setupInsightTabs() {
        const tabs = document.querySelectorAll(".insight-tab");
        if (!tabs.length) return;
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            tabs.forEach((btn) => {
              btn.classList.remove("is-active");
              btn.setAttribute("aria-selected", "false");
            });
            tab.classList.add("is-active");
            tab.setAttribute("aria-selected", "true");
            renderInsightCard(tab.dataset.insight);
          });
        });
      })();

      function cardHtml(p) {
        const cat = window.normalizeCategoryId(p.categoryId);
        const catLabel = window.getCategoryLabel(cat);
        const href = `post.html?id=${encodeURIComponent(p.id)}`;

        return `
          <article class="card">
            <div class="meta">
              ${catLabel ? `<span class="category-badge"><i class="fa-solid fa-hashtag"></i> ${escapeHtml(catLabel)}</span>` : ""}
              <span><i class="fa-regular fa-calendar"></i> ${escapeHtml(fmtDate(p.publishedAt))}</span>
            </div>

            <a class="title-link" href="${href}">
              ${escapeHtml(p.title || "")}
            </a>

            ${p.eyecatchUrl ? `<img class="thumb" src="${escapeHtml(p.eyecatchUrl)}" alt="" loading="lazy" />` : ""}

            ${p.summary ? `<p class="muted">${escapeHtml(p.summary)}</p>` : ""}
          </article>
        `;
      }

      async function fetchPosts() {
        const r = await fetch("/api/posts", { cache: "no-store" });
        if (!r.ok) throw new Error("Failed to fetch /api/posts");
        const data = await r.json();
        return data.posts || [];
      }

      (async function boot() {
        const recEl = document.querySelector("[data-recommended-list]");
        const latestEl = document.querySelector("[data-latest-list]");
        const catEl = document.querySelector("[data-category-shortcuts]");
        const statusEl = document.querySelector("[data-latest-status]");
        const moreBtn = document.querySelector("[data-load-more]");

        let allPosts = [];
        let shown = 0;
        const PAGE_SIZE = 6;

        function renderRecommended() {
          if (!recEl) return;
          const pick = allPosts.slice(0, 4); // とりあえず先頭4つ
          recEl.innerHTML = pick.length ? pick.map(cardHtml).join("") : `<p class="status-text">記事がありません</p>`;
        }

        function renderCategories() {
          if (!catEl) return;
          const uniq = Array.from(
            new Set(allPosts.map((p) => window.normalizeCategoryId(p.categoryId)).filter(Boolean))
          );
          catEl.innerHTML = uniq
            .map((id) => {
              const label = window.getCategoryLabel(id);
              return `<a class="badge" href="categories.html?category=${encodeURIComponent(id)}">${escapeHtml(label)}</a>`;
            })
            .join("");
        }

        function renderLatest(reset = false) {
          if (!latestEl) return;

          if (reset) {
            shown = 0;
            latestEl.innerHTML = "";
          }

          const next = allPosts.slice(shown, shown + PAGE_SIZE);
          shown += next.length;

          if (reset && next.length === 0) {
            latestEl.innerHTML = `<p class="status-text">記事がありません</p>`;
          } else {
            latestEl.insertAdjacentHTML("beforeend", next.map(cardHtml).join(""));
          }

          if (moreBtn) {
            moreBtn.style.display = shown < allPosts.length ? "inline-flex" : "none";
          }
          if (statusEl) statusEl.textContent = "";
        }

        try {
          allPosts = await fetchPosts();
          insightPosts = buildInsightPosts(allPosts);
          const activeTab = document.querySelector(".insight-tab.is-active");
          renderInsightCard(activeTab?.dataset.insight || "news");
          renderRecommended();
          renderCategories();
          renderLatest(true);

          if (moreBtn) {
            moreBtn.addEventListener("click", () => renderLatest(false));
          }
        } catch (e) {
          if (recEl) recEl.innerHTML = `<p class="status-text">読み込みに失敗しました</p>`;
          if (latestEl) latestEl.innerHTML = `<p class="status-text">読み込みに失敗しました</p>`;
          const titleEl = document.querySelector("[data-insight-title]");
          const textEl = document.querySelector("[data-insight-text]");
          if (titleEl) titleEl.textContent = "読み込みに失敗しました";
          if (textEl) textEl.textContent = "データの取得に失敗しました。時間をおいて再度お試しください。";
          if (statusEl) statusEl.textContent = String(e);
        }
      })();
    </script>
  </body>
</html>
